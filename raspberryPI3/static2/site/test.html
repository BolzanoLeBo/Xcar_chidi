<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="./images/icon.png">
    <title>X-Car</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.7.3/nipplejs.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eventemitter2@6.4.9/lib/eventemitter2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <script src="ros-script.js"></script>
</head>

<body style="background-image: url('./images/principal_background.png');">

    <div class="align">
        <ul>
            <li><a href="#" onclick="showTab('menu')">Home</a></li>
            <li><a href="#" onclick="showTab('stateMachine')">State Machine</a></li>
            <li><a href="#" onclick="showTab('terminal')">Terminal</a></li>
        </ul>

        <div id="batteryIcon">
            <div id="batteryLevel"></div>
            <div id="batteryText">Not Connection</div>
            <div id="batteryVisual"></div>
        </div>
        
        <div id="menu" class="tab-content container">
            <div id="zone_joystick" style="position: relative;"></div>
            <div id="idleDiv">
                <div class="button-container">
                    <h1 class="larger-text">X-Car</h1>
                    <div id="stateData" class="hidden"></div>
                    <h2><em class="italic-text">"Intelligent vehicle designed to support the INSA community."</em></h2>
                    <button onclick="redirectAndSelectMode('manual.html', 1)">Manual Mode</button>
                    <button onclick="redirectAndSelectMode('tracking.html', 3)">Tracking Mode</button>
                    <button onclick="redirectAndSelectMode('autonomous.html', 2)">Autonomous Mode</button>
                    <buttonE onclick="redirectAndSelectMode('emergency.html', 4)">Emergency Mode</buttonE>
                    <button class="logout-b" onclick="redirect('index.html')">Logout</button>
                </div>
            </div>

            <div id="securityDiv">
                <h1 class="larger-text">X-Car</h1>
                <h2>Security Mode</h2>
                <h2 class="blinking alarm">Obstacle detected</h2>
                <div id="stateData" class="hidden"></div>
                <h2><em class="italic-text">Obstacles have been detected, please check around the vehicle.</em></h2>
                <img src="./images/obstacle.png" alt="Obstacle" class="controller-image">
                <div id="zone_joystick" style="position: relative;"></div>
                <div class="button-container">
                    <buttonE onclick="redirectAndSelectMode('emergency.html', 4)">Emergency Mode</buttonE>
                </div>
            </div>

            <div id="manualDiv">
                <h2 id="manualTitle" class="blinking">Manual Mode</h2>
                <div id="stateData" class="hidden"></div>
                <h2><em class="italic-text">Please take the joystick to use the vehicle.</em></h2>
                <img src="./images/joystick.png" alt="Joystick Image" class="controller-image">
                <div id="zone_joystick" style="position: relative;"></div>
                <div class="button-container">
                    <button onclick="redirectAndSelectMode('home.html', 0)">Return</button>
                    <buttonE onclick="redirectAndSelectMode('emergency.html', 4)">Emergency Mode</buttonE>
                </div>
            </div>

            <div id="trackingDiv">
                <h1 class="larger-text">X-Car</h1>
                <h2 class="blinking">Tracking Mode</h2>
                <div id="stateData" class="hidden"></div>
                <h2><em class="italic-text">The vehicle is ready to follow you.</em></h2>
                <img src="./images/tracking1.png" alt="Tracking Image" class="controller-image">
                <div class="button-container">
                    <button onclick="redirectAndSelectMode('home.html', 0)">Return</button>
                    <buttonE onclick="redirectAndSelectMode('emergency.html', 4)">Emergency Mode</buttonE>
                </div>
            </div>

            <div id="autoDiv">
                <h1 class="larger-text">X-Car</h1>
                <h2 class="blinking">Autonomous Mode</h2>
                <div id="stateData" class="hidden"></div>
                <h2><em class="italic-text">Vehicle on the way.</em></h2>
                <img src="./images/autonomous.png" alt="Autonomous" class="controller-image">
                <div class="button-container">
                    <button onclick="redirectAndSelectMode('home.html', 0)">Return</button>
                    <buttonE onclick="redirectAndSelectMode('emergency.html', 4)">Emergency Mode</buttonE>
                </div>
            </div>

            <div id="emergencyDiv">
                <h1 class="larger-text">X-Car</h1>
                <h2 class="blinking alarm">Emergency Mode</h2>
                <div id="stateData" class="hidden"></div>
                <h2><em class="text">Please click on</em><em class="italic-text">"everything is fine"</em><p class="text">to return to the home page.</p></h2>
                <img src="./images/stop.png" alt="Stop Image" class="controller-image">
                <div class="button-container">
                    <button onclick="redirectAndSelectMode('home.html', 5)">Everything fine!</button>
                </div>
            </div>
        </div>

        <div id="stateMachine" class="tab-content container">
            <div class="corner-box">
                <div class="box3"></div>
                <div class="text">État actuel<br></div>
            </div>
            <div class="corner-box">
                <div class="box"></div>
                <div class="text">États disponibles</div>
            </div>
            <div class="corner-box">
                <div class="box2"></div>
                <div class="text">État précédent</div>
            </div>
            <div class="state-machine">
        
                <div class="state" id="stop" onclick="changeState('stop'); redirectAndSelectMode('emergency.html', 4);">
                    <div class="state-name">Emergency Stop</div>
                </div>
                <div class="state" id="tracking" onclick="changeState('tracking'); redirectAndSelectMode('tracking.html', 3);">
                    <div class="state-name">Tracking Mode</div>
                </div>
                <div class="state" id="autonomous" onclick="changeState('autonomous'); redirectAndSelectMode('autonomous.html', 2);">
                    <div class="state-name">Autonomous Mode</div>
                </div>
                <div class="state" id="manual" onclick="changeState('manual'); redirectAndSelectMode('manual.html', 1);">
                    <div class="state-name">Manual Mode</div>
                </div>
                <div class="state" id="security" onclick="changeState('security')">
                    <div class="state-name">Security Mode</div>
                </div>
                <div class="state active" id="idle" onclick="changeState('idle'); redirectAndSelectMode('home.html', 0);">
                    <div class="state-name">Idle</div>
                </div>

            </div>
        </div>

        <div id="terminal" class="tab-content container">
            <div id="terminal-content">
                <div id="stateInfo">
                    <h2>State Information</h2>
                </div>
            </div>
        </div>
    </div>

    <script>
        function redirectAndSelectMode(page, mode) {
            selectMode(mode);
        }

        function redirect(page) {
            window.location.href = 'index.html';
        }

        function showTab(tabName) {
            var tabs = document.getElementsByClassName('tab-content');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].style.display = 'none';
            }

            document.getElementById(tabName).style.display = 'block';
        }

        function showAppropriateDiv() {
            var securityDiv = document.getElementById("securityDiv");
            var manualDiv = document.getElementById("manualDiv");
            var idleDiv = document.getElementById("idleDiv");
            var autoDiv = document.getElementById("autoDiv");
            var emergencyDiv = document.getElementById("emergencyDiv");
            var trackingDiv = document.getElementById("trackingDiv");


            if (state === 0) {
                securityDiv.style.display = "none";
                manualDiv.style.display = "none";
                idleDiv.style.display = "block";
                emergencyDiv.style.display = "none";
                autoDiv.style.display = "none";
                trackingDiv.style.display = "none";
            } else if (state === 1) {
                securityDiv.style.display = "none";
                manualDiv.style.display = "block";
                idleDiv.style.display = "none";
                emergencyDiv.style.display = "none";
                autoDiv.style.display = "none";
                trackingDiv.style.display = "none";
            } else if (state === 2) {
                securityDiv.style.display = "none";
                manualDiv.style.display = "none";
                idleDiv.style.display = "none";
                emergencyDiv.style.display = "none";
                autoDiv.style.display = "block";
                trackingDiv.style.display = "none";
            }
            else if (state === 3) {
                securityDiv.style.display = "none";
                manualDiv.style.display = "none";
                idleDiv.style.display = "none";
                emergencyDiv.style.display = "none";
                autoDiv.style.display = "none";
                trackingDiv.style.display = "block";
            }
            else if (state === 4) {
                securityDiv.style.display = "block";
                manualDiv.style.display = "none";
                idleDiv.style.display = "none";
                emergencyDiv.style.display = "none";
                autoDiv.style.display = "none";
                trackingDiv.style.display = "none";
            }
            else if (state === 5) {
                securityDiv.style.display = "none";
                manualDiv.style.display = "none";
                idleDiv.style.display = "none";
                emergencyDiv.style.display = "block";
                autoDiv.style.display = "none";
                trackingDiv.style.display = "none";
            }  
        }

        showAppropriateDiv();

        let currentState = 'idle';
        let previousState = null;

        if (currentState == 'idle') {
            document.getElementById('idle').style.left ='25%';
            document.getElementById('idle').style.top ='30%';
            document.getElementById('manual').style.left ='75%';
            document.getElementById('manual').style.top ='30%'; 
            document.getElementById('tracking').style.left ='35%';
            document.getElementById('tracking').style.top ='-15%'; 
            document.getElementById('autonomous').style.left ='35%';
            document.getElementById('autonomous').style.top ='75%'; 
            document.getElementById('security').style.left ='-25%';
            document.getElementById('security').style.top ='10%'; 
            document.getElementById('stop').style.left ='-20%';
            document.getElementById('stop').style.top ='60%';                      
        }

        function changeState(newState) {

            if (newState !== currentState) {
                previousState = currentState;
                currentState = newState;

            if (currentState == 'manual') {
                document.getElementById(currentState).classList.add('active');
                document.getElementById('idle').classList.add('available');
                document.getElementById('tracking').classList.add('available');
                document.getElementById('autonomous').classList.add('available');
                document.getElementById('stop').classList.add('available');                   
            }

                // Remove classes from all states and hide all lines
                document.querySelectorAll('.state').forEach((state) => {
                    state.classList.remove('active', 'previous');
                });
                document.querySelectorAll('.line').forEach((line) => {
                    line.style.display = 'none';
                });

                // Adiciona a classe active ao estado atual
                document.getElementById(currentState).classList.add('active');

                // Adiciona a classe previous ao estado anterior e exibe a linha correspondente
                if (previousState) {
                    document.getElementById(previousState).classList.add('previous');
                    // if (previousState == 'idle') {
                    //     document.querySelector('.line-idle-' + currentState.toLowerCase()).style.display = 'block';
                    // } else if (previousState == 'manual') {
                    //     document.querySelector('.line-manual-' + currentState.toLowerCase()).style.display = 'block';
                    // }
                    var topValue_n = document.getElementById(previousState).style.top;
                    var leftValue_n = document.getElementById(previousState).style.left;
                    var topValue_a = document.getElementById(currentState).style.top;
                    var leftValue_a = document.getElementById(currentState).style.left;

                    document.getElementById(currentState).style.left =leftValue_n;
                    document.getElementById(currentState).style.top =topValue_n; 
                    document.getElementById(previousState).style.left =leftValue_a;
                    document.getElementById(previousState).style.top =topValue_a;

                }
            }
        }
        createJoystick();
    </script>

</body>

</html>